version: "3.8"

services:
  db:
    image: mariadb:10.6
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: crater
      MYSQL_USER: crater
      MYSQL_PASSWORD: ${CRATER_DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${CRATER_DB_ROOT_PASSWORD}
    volumes:
      - crater_db:/var/lib/mysql
    networks:
      - dokploy-network

  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        user: crater-user
        uid: 1000
    image: crater-php
    restart: unless-stopped
    working_dir: /var/www
    depends_on:
      - db
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: ${CRATER_APP_URL}
      APP_KEY: ${CRATER_APP_KEY}

      DB_CONNECTION: mysql
      DB_HOST: db
      DB_PORT: 3306
      DB_DATABASE: crater
      DB_USERNAME: crater
      DB_PASSWORD: ${CRATER_DB_PASSWORD}

      TRUSTED_PROXIES: "*"

    # ðŸ”¥ Importante: si en redeploy falta vendor/, lo reconstruye antes de levantar PHP-FPM
    command: >
      sh -lc "
      cd /var/www &&
      git config --global --add safe.directory /var/www || true &&
      mkdir -p storage/framework/cache/data storage/framework/sessions storage/framework/views storage/framework/testing storage/logs bootstrap/cache &&
      chmod -R 775 storage bootstrap/cache || true &&
      if [ ! -f vendor/autoload.php ]; then
        composer install --no-interaction --prefer-dist --optimize-autoloader;
      fi &&
      php-fpm
      "
    volumes:
      # CÃ³digo del repo (Dokploy lo clona). Esto hace que exista artisan/public/etc.
      - ./:/var/www

      # Persistencias
      - crater_db:/var/lib/mysql
      - crater_storage:/var/www/storage
      - crater_public:/var/www/public/storage

      # ðŸ”¥ Para que NO se pierda vendor en redeploy (aunque el repo se vuelva a clonar)
      - crater_vendor:/var/www/vendor

      # Si tienes este archivo en tu repo, ok; si no existe, bÃ³rralo del compose
      - ./docker-compose/php/uploads.ini:/usr/local/etc/php/conf.d/uploads.ini:rw,delegated
    networks:
      - dokploy-network

  crater:
    image: nginx:1.17-alpine
    restart: unless-stopped
    depends_on:
      - app
    ports:
      - "80"
    volumes:
      - ./:/var/www:ro
      - crater_public:/var/www/public/storage

      # âœ… Monta la config correcta (si no existe el archivo en el repo â†’ 404)
      - ./docker-compose/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - dokploy-network

  cron:
    image: crater-php
    restart: unless-stopped
    depends_on:
      - app
    working_dir: /var/www
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      APP_URL: ${CRATER_APP_URL}
      APP_KEY: ${CRATER_APP_KEY}
      DB_CONNECTION: mysql
      DB_HOST: db
      DB_PORT: 3306
      DB_DATABASE: crater
      DB_USERNAME: crater
      DB_PASSWORD: ${CRATER_DB_PASSWORD}
    command: >
      sh -lc "
      cd /var/www &&
      while true; do
        php artisan schedule:run --no-interaction;
        sleep 60;
      done
      "
    volumes:
      - ./:/var/www
      - crater_storage:/var/www/storage
      - crater_public:/var/www/public/storage
      - crater_vendor:/var/www/vendor
    networks:
      - dokploy-network

volumes:
  crater_db:
  crater_storage:
  crater_public:
  crater_vendor:

networks:
  dokploy-network:
    external: true
